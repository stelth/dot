env:
  CIRRUS_SHELL: bash -il
  DARWIN_BUILD_IMAGE: ghcr.io/cirruslabs/macos-ventura-base:latest
  LINUX_BUILD_IMAGE: debian:11

build_template: &BUILD_TEMPLATE
  only_if: $CIRRUS_BRANCH == $CIRRUS_DEFAULT_BRANCH || $CIRRUS_TAG != "" || $CIRRUS_PR != "" || $CIRRUS_BUILD_SOURCE == ""
  name: build_${CIRRUS_OS}_${ARCH}
  timeout_in: 120m
  env:
    RUST_BACKTRACE: "1"
    NIX_INSTALLER_NO_CONFIRM: "true"
    NIX_INSTALLER_TAG: "v0.7.0"
    NIX_INSTALLER_EXTRA_CONF: |
      trusted-users = root admin @sudo @wheel
      extra-systems = x86_64-${CIRRUS_OS} aarch64-${CIRRUS_OS}
      substituters = https://cache.nixos.org https://devenv.cachix.org
      trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
      sandbox = false
  install_nix_script: |
    if [[ "$CIRRUS_OS" = "linux" ]]; then
      curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --init none
    else
      curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
    fi
  flake_check_script: NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM=1 nix flake check -j auto --system ${ARCH//arm/aarch}-${CIRRUS_OS} --show-trace --accept-flake-config

build_darwin_task:
  macos_instance:
    image: $DARWIN_BUILD_IMAGE
  matrix:
    - env:
        ARCH: arm64
    - env:
        ARCH: x86_64
  install_rosetta_script: softwareupdate --install-rosetta --agree-to-license
  <<: *BUILD_TEMPLATE

build_linux_task:
  matrix:
    - arm_container:
        image: $LINUX_BUILD_IMAGE
        cpu: 4
        memory: 16G
      env:
        ARCH: arm64
        USER: root
    - container:
        image: $LINUX_BUILD_IMAGE
        cpu: 4
        memory: 16G
      env:
        ARCH: x86_64
        USER: root
  install_env_script: apt update && apt -y install curl git sudo
  <<: *BUILD_TEMPLATE
